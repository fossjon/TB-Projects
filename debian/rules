#!/usr/bin/make -f
#                                                       -*- makefile -*-
# debian/rules file for the Debian/GNU Linux stunnel package
# Copyright 2003 by Julien LEMOINE <speedblue@debian.org>

include /usr/share/quilt/quilt.make

DEB_HOST_GNU_TYPE   ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
DEB_BUILD_GNU_TYPE  ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)
PROXY_CONNECT	     = debian/connect-proxy_dunbar.patch
CFLAGS 		     = -Wall -g
ifneq (,$(findstring noopt,$(DEB_BUILD_OPTIONS)))
  CFLAGS += -O0
else
  CFLAGS += -O2
endif

build: patch build-stamp
build-stamp:
	dh_testdir

	CFLAGS="$(CFLAGS)" ./configure --prefix=/usr 			\
	  --host=$(DEB_HOST_GNU_TYPE) --build=$(DEB_BUILD_GNU_TYPE)	\
	  --localstatedir=/var --enable-ssllib-cs 			\
	  --with-cert-dir=/etc/ssl/certs --with-pem-dir=/etc/ssl/certs	\
	  --enable-ipv6 --with-threads=pthread
	$(MAKE) -C src
	$(MAKE) -C doc
	touch build-stamp

clean: clean-patched unpatch
clean-patched:
	dh_testdir
	dh_testroot

	[ ! -f Makefile ] || $(MAKE) distclean

	dh_clean build-stamp doc/stunnel4.8

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

	$(MAKE) -C src install prefix=$(CURDIR)/debian/stunnel4/usr
	$(MAKE) -C doc install prefix=$(CURDIR)/debian/stunnel4/usr

	ln doc/stunnel.8 doc/stunnel4.8

	# Manpages will be installed by dh_installman
	rm -rf $(CURDIR)/debian/stunnel4/man
	rm -rf $(CURDIR)/debian/stunnel4/usr/man

	install -p -m 0644 tools/stunnel.conf-sample 			\
	  $(CURDIR)/debian/stunnel4/etc/stunnel/stunnel.conf

	# Rename binary
	mv $(CURDIR)/debian/stunnel4/usr/bin/stunnel 			\
	  $(CURDIR)/debian/stunnel4/usr/bin/stunnel4

	# Move docs into propper dir
	mv $(CURDIR)/debian/stunnel4/usr/share/doc/stunnel		\
	  $(CURDIR)/debian/stunnel4/usr/share/doc/stunnel4

	[ ! -s debian/lintian.overrides ] || \
	  install -p -m 0644 -D $(CURDIR)/debian/lintian.overrides	\
	    $(CURDIR)/debian/stunnel4/usr/share/lintian/overrides/stunnel4

binary-indep:
	dh_testdir
	dh_testroot
	dh_installdocs -i
	dh_installchangelogs -i
	dh_compress -i
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i


binary-arch: install
	dh_testdir
	dh_testroot
	dh_installdocs -a
	dh_installexamples -a
	dh_installman -a
	dh_installchangelogs -a ChangeLog
	dh_installinit -a -- defaults
	dh_installppp -a --name=0stunnel4
	dh_installlogrotate -a
	dh_install -a debian/StunnelConf-0.1.pl usr/share/doc/stunnel4/contrib
	dh_link -a
	dh_strip -a
	dh_compress -a --exclude=StunnelConf-0.1.pl
	dh_fixperms -a
	dh_makeshlibs -a -l debian/stunnel4/usr/lib
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary: binary-indep binary-arch
.PHONY: build clean binary-indep binary-arch binary install
