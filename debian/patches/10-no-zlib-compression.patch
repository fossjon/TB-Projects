Description: Do not depend on zlib compression being available.
 The Debian OpenSSL package is built without support for zlib
 compression since version 1.0.1e-5.
Forwarded: not-yet
Author: Peter Pentchev <roam@ringlet.net>
Last-Update: 2014-08-08

--- a/src/ssl.c
+++ b/src/ssl.c
@@ -118,11 +118,10 @@
         comp->method=COMP_zlib();
         if(!comp->method || comp->method->type==NID_undef) {
             OPENSSL_free(comp);
-            s_log(LOG_ERR, "Failed to initialize compression method");
-            return 1;
+        } else {
+            comp->name=(char *)(comp->method->name);
+            sk_SSL_COMP_push(ssl_comp_methods, comp);
         }
-        comp->name=(char *)(comp->method->name);
-        sk_SSL_COMP_push(ssl_comp_methods, comp);
     }
 
     /* also insert one of obsolete (ZLIB/RLE) algorithms */
@@ -138,9 +137,13 @@
         comp->id=0xe1; /* 225 - within private range (193 to 255) */
         comp->method=COMP_rle();
     } else {
-        s_log(LOG_INFO, "Compression enabled: %d algorithm(s)",
-            sk_SSL_COMP_num(ssl_comp_methods));
-        OPENSSL_free(comp);
+	const int count = sk_SSL_COMP_num(ssl_comp_methods);
+	OPENSSL_free(comp);
+	if(count==0) {
+	    s_log(LOG_ERR, "No valid compression algorithms found");
+	    return 1;
+	}
+        s_log(LOG_INFO, "Compression enabled: %d algorithm(s)", count);
         return 0;
     }
     if(!comp->method || comp->method->type==NID_undef) {
--- a/src/options.c
+++ b/src/options.c
@@ -159,9 +159,9 @@
         if(strcasecmp(opt, "compression"))
             break;
         if(SSLeay()>=0x00908051L && !strcasecmp(arg, "deflate"))
-            new_global_options.compression=COMP_DEFLATE;
+            return "deflate compression is not really implemented in OpenSSL";
         else if(!strcasecmp(arg, "zlib"))
-            new_global_options.compression=COMP_ZLIB;
+            return "zlib compression is disabled in the Debian package of OpenSSL";
         else if(!strcasecmp(arg, "rle"))
             new_global_options.compression=COMP_RLE;
         else
